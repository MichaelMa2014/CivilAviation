{% extends 'base.html' %}
{% block title %}Home{% endblock %}
{% block extralinks %}
    <!-- Vue.js -->
    <script src="../static/js/vue.js"></script>
    <!-- Mapbox GL -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.32.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.32.1/mapbox-gl.css' rel='stylesheet' />
    <!-- Mapbox GL Draw Tool -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v0.16.0/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v0.16.0/mapbox-gl-draw.css' type='text/css' />
{% endblock %}
{% block extrastyles %}
{% endblock %}
{% block sidebar %}
    <div id="info" class="sidebar-nav navbar-collapse">
        <table class="table" style="table-layout: fixed; text-align: center">
            <thead>
                <tr>
                    <th style="text-align: center">Attr</th>
                    <th style="text-align: center">Value</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(value, key) in flightInfo">
                    <td style="word-break:break-all">{%  templatetag openvariable %} key {% templatetag closevariable %}</td>
                    <td style="word-break:break-all">{%  templatetag openvariable %} value {% templatetag closevariable %}</td>
                </tr>
            </tbody>
        </table>
    </div>
{% endblock %}
{% block main %}
    <div class="span_11" style="height: 100%">
        <!-- Bing 地图 -->
        <div id="map" style="width:100%;height:100%;">
        </div>
    </div>
    <script type='text/javascript'>
        console.log("Drawing main map...");
        //Vue
        var v = new Vue({
            el: '#info',
            data: {
                flightInfo: [],
            },
        });

        //mapbox GL地图函数
        mapboxgl.accessToken = 'pk.eyJ1Ijoic3R1cGlnIiwiYSI6ImNpanV2c211bTBoaGp0c204cDFhNGltMW8ifQ.i2d7l3ljIr4GvyLWj6Hh3w';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v9',
            zoom: 5,
            minZoom: 3,
            center: [116.46, 39.92],
            renderWorldCopies: false,
        });

        //MapboxDraw Tool
        var draw = new MapboxDraw({
            displayControlsDefault:false,
            styles: [
                // line stroke
                {
                    "id": "gl-draw-line",
                    "type": "line",
                    "filter": ["all", ["==", "$type", "LineString"], ["!=", "mode", "static"]],
                    "layout": {
                      "line-cap": "round",
                      "line-join": "round"
                    },
                    "paint": {
                      "line-color": "#D20C0C",
                      "line-width": 4
                    }
                },
            ]
        });

        map.addControl(draw);
        map.on('zoomend',function () {
            getdatabyrect();
        });
        map.on('moveend',function(){
            getdatabyrect();
        });
        map.on('click', function (e) {
            if(e.originalEvent.target.id.match('flight_marker'))
            {
                draw = draw.deleteAll();
                id = e.originalEvent.target.id.replace('flight_marker_','');
                jQuery.ajax({
                    url: "/getInfoByID/" + id,
                    success: function (data) {
                        v.flightInfo = data[0];

                    }
                });
                jQuery.ajax({
                    url: "/getRouteByID/" + id,
                    success: function (data) {
                        data.forEach(function (route) {
                            if(route.length > 1)
                            {
                                draw.add({ type: 'LineString', coordinates: route});
                            }
                        })
                    }
                })
            }

        });

        function stdlnglat(lnglats){
            s = [Math.floor(lnglats[0][0]), Math.floor(lnglats[0][1]), Math.ceil(lnglats[1][0]), Math.ceil(lnglats[1][1])];
            return s;
        }
        function getdatabydate() {
            jQuery.ajax({
                url: "/getDataByDate/2017-01-23",
                success: function (data) {
                    console.log(new Date().getSeconds())
                    console.log("Successfully load data from API server.");

                    for(var i in data) {
                        var img = document.createElement('img');
                            img.src = '../static/images/airplane_2.svg'
                            img.style.width = '30px';
                            img.style.height = '30px';

                            // add marker to map
                            var m = new mapboxgl.Marker(img)
                                .setLngLat([data[i].lon,data[i].lat])
                                .addTo(map);
                    }
                    console.log(new Date().getSeconds());
                    console.log("Successfully draw pushpins");
                }
            })
        }
        function getdatabyrect() {
            jQuery.ajax({
                url: "/getDataByRect/"+stdlnglat(map.getBounds().toArray())+','+Math.ceil(map.getZoom()),
                success: function (data) {
                    parent = document.getElementsByClassName('mapboxgl-canvas-container mapboxgl-interactive')[0];
                    while(parent.childNodes.length > 1)
                    {
                        parent.removeChild(parent.lastChild);
                    }
                    for(var i in data) {
                        var img = document.createElement('img');
                            img.src = '../static/images/airplane_2.svg';
                            img.id = 'flight_marker_' + data[i].id;
                            img.style.width = '30px';
                            img.style.height = '30px';

                        // add marker to map
                        var m = new mapboxgl.Marker(img)
                                .setLngLat([data[i].lon,data[i].lat])
                                .addTo(map);
                    }
                }
            })
        }

        getdatabyrect();
    </script>
{% endblock %}

{% block bottom %}
<div style="text-align: center">This is the bottom from index.html</div>
{% endblock %}


